#!/usr/bin/env node
var fs        = require("fs")
  , path      = require("path")
  , tty       = require('tty')
  , exec      = require('child_process').exec
  , argv      = require('optimist').argv
  , stack     = []
  , success   = true
  , args      = {env: process.env}
  , base_path
  , dirs
  , files
  , test
  ;

// work for /test and /tests
// will throw otherwise
try {
  base_path = path.resolve(".", "tests");
  dirs      = fs.readdirSync(base_path);
} catch (exc) {
  base_path = path.resolve(".", "test");
  dirs      = fs.readdirSync(base_path);
}

// set env vars in a platform agnostic way
(Array.isArray(argv.e) ? argv.e : argv.e ? [argv.e] : [])
.forEach(function (env_var) {
  if(env_var.indexOf("=")!==-1) {
    var split = env_var.split("=");
    args.env[split[0]] = split[1];
  }
});

// try to get tty size to give to child process
var isatty = tty.isatty(1) && tty.isatty(2)
  , width  = isatty
    ? process.stdout.getWindowSize
      ? process.stdout.getWindowSize(1)[0]
      : tty.getWindowSize
        ? tty.getWindowSize()[1]
        : null
    : null
  ;

if(typeof width === "number") {
  args.env.SPECIFY_MAXCOLS = width;
}

// set a reporter
if(typeof argv.r === "string") {
  args.env.SPECIFY_REPORTER = argv.r;
}

function runTests(tests, previousStatus) {
  if(success) {
    success = previousStatus;
  }
  if(tests[0]) {
    exec("node " + tests[0], args, ppTest(tests));
  } else {
    return process.exit(success ? 0 : 1);
  }
}

function ppTest (tests) {
  var file_path = tests.shift();
  return function (err, stdout, stderr) {
    process.stdout.write(stdout);
    process.stdout.write(stderr);
    runTests(tests, !(err || stderr));
  };
}

for(var dir in dirs) {
  var dir_path = path.resolve(base_path, dirs[dir]);
  if(fs.statSync(dir_path).isDirectory()) {
    files = fs.readdirSync(dir_path);
    for (var file in files) {
      var file_path = path.resolve(dir_path, files[file]);
      if(/\.js$|\.node$/.test(file_path)) {
        stack.push(file_path);
      }
    }
  }
}

runTests(stack, true);